{% extends "teams/base.html" %}

{% load i18n to_json utils_tags teams_tags paginator markup media_compressor profiles_tags %}

{% block title %}
    {% trans 'Dashboard' %} - {{ team }} | Amara
{% endblock %}

{% block body_attrs %}class="v1 team_dashboard"{% endblock %}

{% block css %}
    {{ block.super }}
    {% include_bundle "widget-css"%}
{% endblock %}

{% block scripts %}
    {{ block.super }}
    {% include_bundle "unisubs-offsite-compiled" %}
    {% include_bundle "js-teams" %}
    <script src="{% url teams:rpc_api %}" type="text/javascript"></script>
    <script type="text/javascript">
        window.WIDGET_SETTINGS = {{ widget_settings|to_json|safe }};
        window.REQUEST_GET_LANG = '{{ request.GET.lang }}';
        window.ASSIGN_TASK_AJAX_URL = '{% url teams:assign_task_ajax slug=team.slug %}';
        window.ASSIGNEE = '{% firstof request.user.id -1 %}';
        window.TEAM_SLUG = '{{ team.slug }}';
        window.USER_LANGS = {{ user.get_languages.count }};
        unisubs.languages = [];
    </script>
{% endblock %}

{% block select_language_dialog %}
    {% select_language_dialog %}
{% endblock %}

{% block view_content %}

    <div class="grid_8 view omega">
        {% with "dashboard" as current %}
            {% if not project %}
                {% include 'teams/_tabs.html' %}
            {% else %}
                {% include 'teams/_tabs_projects.html' %}
            {% endif %}
        {% endwith %}

        {% if team|is_team_member:user %}
            {% if user_tasks %}
                <h3>
                    Your tasks ({{ user_tasks.count }})
                </h3>

                <ul class="listing tasks yours">
                    {% for task in user_tasks %}
                        <li>
                            <a href="{{ task.team_video.video.get_absolute_url }}" title="View video">
                                &#8220;{{ task.team_video }}&#8221;
                            </a>
                            {% if task.expiration_date != None %}
                                {% if task.future %}
                                    <span class="due">Due in {{ task.expiration_date|timeuntil }}</span>
                                {% else %}
                                    <span class="due overdue">Overdue by {{ task.expiration_date|timesince }}</span>
                                {% endif %}
                            {% endif %}
                            <a href="{{ task.get_widget_url }}" class="perform-task perform-task-{{ task.pk }} button reduced" id="task-{{ task.id }}">
                                {{ task.get_type_display }}
                                {% if task.get_language_display %}
                                    {{ task.get_language_display }}
                                {% endif %}
                            </a>
                            {% include "teams/_perform_task_js.html" %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Getting started is easy! Just find a video below that youâ€™d like to help with and select the task you want to perform.</p>
                <p><a href="#">Learn more</a> about working in Amara.</p>
            {% endif %}
            
            <h3>
                <a href="" class="mode"></a>
                Videos that need your help ({{ videos.items|length }})
            </h3>

            {% if not user.get_languages %}
                <p class="view-notice">
                    <strong><a href="#" data-modal="language_modal" id="lang_select_btn">{% trans 'Tell us what languages you speak' %}</a> {% trans "and we'll narrow this list for you" %}</strong>
                </p>
            {% endif %}

            {% if videos %}
                <ul class="listing videos">
                    {% for id, team_video in videos.items %}
                        <li>
                            <a href="{{ team_video.video.get_absolute_url }}" class="thumb">
                                <img src="{{ team_video.get_thumbnail }}" alt="{{ video.title }}">
                            </a>
                            <h4>
                                <a href="{{ team_video.video.get_absolute_url }}">{{ video|truncatewords:15 }}</a>
                            </h4>
                            <div class="languages">
                                    {% if team_video.tasks|length > 1 %}
                                        <a href="#" title="Get started now">
                                            {{ team_video.tasks|length }}
                                            {% trans " languages needed" %}
                                        </a>
                                        <div>
                                            <span class="expand">View all</span>
                                            <ul>
                                                {% for task in team_video.tasks %}
                                                    <li>
                                                        <a class="perform-task-{{ task.pk }}" href="{{ task.get_widget_url }}" title="Get started now">
                                                            {% if task.get_type_display == 'Subtitle' %}
                                                                {% trans "Create Subtitles" %}
                                                            {% else %}
                                                                {{ task.get_type_display }}
                                                                {% if task.get_language_display %}
                                                                    {{ task.get_language_display }}
                                                                {% endif %}
                                                            {% endif %}
                                                        </a>
                                                    </li>
                                                    {% include "teams/_perform_task_js.html" %}
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% else %}
                                        {% with task=team_video.tasks|first %}
                                        <a href="{{ task.get_widget_url }}" class="perform-task-{{ task.pk }}" title="Get started now">
                                                {% if task.get_type_display == 'Subtitle' or task.get_type_display == 'Translate' %}
                                                    Needs {{ task.get_language_display }} subtitles
                                                {% else %}
                                                    {{ task.get_language_display }} subtitles need 
                                                    {{ task.get_type_display }}
                                                {% endif %}
                                            </a>
                                            <div>
                                                <span>Start now</span>
                                            </div>
                                            {% include "teams/_perform_task_js.html" %}
                                        {% endwith %}
                                    {% endif %}
                            </div>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="empty">
                    {% trans "Sorry, nothing to see here" %}
                    ...
                </p>
            {% endif %}
        {% else %}
        <p>These are just a few of the exciting videos you can help us with! <a href="">Join now</a></p>
        {% endif %}
    </div>
    <script type="text/javascript">
        unisubs.widget.WidgetController.makeGeneralSettings(window.WIDGET_SETTINGS);
    </script>
{% endblock %}
